<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Train, deploy and record metadata on Kubeflow from Notebooks | Kubeflow</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Train, deploy and record metadata on Kubeflow from Notebooks" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Demonstration of how lineage tracking works" />
<meta property="og:description" content="Demonstration of how lineage tracking works" />
<link rel="canonical" href="https://blog.kubeflow.org/jupyter/2020/07/27/lineage-tracking.html" />
<meta property="og:url" content="https://blog.kubeflow.org/jupyter/2020/07/27/lineage-tracking.html" />
<meta property="og:site_name" content="Kubeflow" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-27T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Demonstration of how lineage tracking works","@type":"BlogPosting","headline":"Train, deploy and record metadata on Kubeflow from Notebooks","dateModified":"2020-07-27T00:00:00-05:00","datePublished":"2020-07-27T00:00:00-05:00","url":"https://blog.kubeflow.org/jupyter/2020/07/27/lineage-tracking.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kubeflow.org/jupyter/2020/07/27/lineage-tracking.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://blog.kubeflow.org/feed.xml" title="Kubeflow" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-135379910-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Train, deploy and record metadata on Kubeflow from Notebooks | Kubeflow</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Train, deploy and record metadata on Kubeflow from Notebooks" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Demonstration of how lineage tracking works" />
<meta property="og:description" content="Demonstration of how lineage tracking works" />
<link rel="canonical" href="https://blog.kubeflow.org/jupyter/2020/07/27/lineage-tracking.html" />
<meta property="og:url" content="https://blog.kubeflow.org/jupyter/2020/07/27/lineage-tracking.html" />
<meta property="og:site_name" content="Kubeflow" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-27T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Demonstration of how lineage tracking works","@type":"BlogPosting","headline":"Train, deploy and record metadata on Kubeflow from Notebooks","dateModified":"2020-07-27T00:00:00-05:00","datePublished":"2020-07-27T00:00:00-05:00","url":"https://blog.kubeflow.org/jupyter/2020/07/27/lineage-tracking.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kubeflow.org/jupyter/2020/07/27/lineage-tracking.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://blog.kubeflow.org/feed.xml" title="Kubeflow" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-135379910-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>



<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Kubeflow</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Train, deploy and record metadata on Kubeflow from Notebooks</h1><p class="page-description">Demonstration of how lineage tracking works</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-07-27T00:00:00-05:00" itemprop="datePublished">
        Jul 27, 2020
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      21 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#jupyter">jupyter</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/kubeflow/blog/tree/master/_notebooks/2020-07-27-lineage-tracking.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/kubeflow/blog/master?filepath=_notebooks%2F2020-07-27-lineage-tracking.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/kubeflow/blog/blob/master/_notebooks/2020-07-27-lineage-tracking.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Train-and-deploy-on-Kubeflow-from-Notebooks">Train and deploy on Kubeflow from Notebooks </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Prerequisites">Prerequisites </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Verify-we-have-a-GCP-account">Verify we have a GCP account </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Install-Required-Libraries">Install Required Libraries </a></li>
<li class="toc-entry toc-h2"><a href="#Code-to-train-and-predict">Code to train and predict </a></li>
<li class="toc-entry toc-h2"><a href="#Wrap-Training-and-Prediction-in-a-class">Wrap Training and Prediction in a class </a></li>
<li class="toc-entry toc-h2"><a href="#Train-your-Model-Locally">Train your Model Locally </a></li>
<li class="toc-entry toc-h2"><a href="#Predict-locally">Predict locally </a></li>
<li class="toc-entry toc-h2"><a href="#Use-Kubeflow-Fairing-to-Launch-a-K8s-Job-to-train-your-model">Use Kubeflow Fairing to Launch a K8s Job to train your model </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Configure-The-Docker-Registry-For-Kubeflow-Fairing">Configure The Docker Registry For Kubeflow Fairing </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Use-Kubeflow-fairing-to-build-the-docker-image">Use Kubeflow fairing to build the docker image </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Build-the-base-image">Build the base image </a></li>
<li class="toc-entry toc-h3"><a href="#Build-the-actual-image">Build the actual image </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Launch-the-K8s-Job">Launch the K8s Job </a></li>
<li class="toc-entry toc-h2"><a href="#Deploy-the-trained-model-to-Kubeflow-for-predictions">Deploy the trained model to Kubeflow for predictions </a></li>
<li class="toc-entry toc-h2"><a href="#Send-an-inference-request-to-the-prediction-server">Send an inference request to the prediction server </a></li>
<li class="toc-entry toc-h2"><a href="#Clean-up-the-prediction-endpoint">Clean up the prediction endpoint </a></li>
<li class="toc-entry toc-h2"><a href="#Track-Models-and-Artifacts">Track Models and Artifacts </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Create-a-workspace">Create a workspace </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Create-a-pipeline-to-train-your-model">Create a pipeline to train your model </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Define-the-pipeline">Define the pipeline </a></li>
<li class="toc-entry toc-h4"><a href="#Compile-the-pipeline">Compile the pipeline </a></li>
<li class="toc-entry toc-h4"><a href="#Submit-the-pipeline-for-execution">Submit the pipeline for execution </a></li>
</ul>
</li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-07-27-lineage-tracking.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Train-and-deploy-on-Kubeflow-from-Notebooks">
<a class="anchor" href="#Train-and-deploy-on-Kubeflow-from-Notebooks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Train and deploy on Kubeflow from Notebooks<a class="anchor-link" href="#Train-and-deploy-on-Kubeflow-from-Notebooks"> </a>
</h1>
<p>This notebook shows you how to use Kubeflow to build, train, and deploy models on Kubernetes.
This notebook walks you through the following</p>
<ul>
<li>Building an XGBoost model inside a notebook</li>
<li>Training the model inside the notebook</li>
<li>Performing inference using the model inside the notebook</li>
<li>Using Kubeflow Fairing to launch training jobs on Kubernetes</li>
<li>Using Kubeflow Fairing to build and deploy a model using <a href="https://www.seldon.io/">Seldon Core</a>
</li>
<li>Using <a href="https://github.com/kubeflow/metadata">Kubeflow metadata</a> to record metadata about your models</li>
<li>Using <a href="https://www.kubeflow.org/docs/pipelines/">Kubeflow Pipelines</a> to build a pipeline to train your model</li>
</ul>
<h2 id="Prerequisites">
<a class="anchor" href="#Prerequisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prerequisites<a class="anchor-link" href="#Prerequisites"> </a>
</h2>
<ul>
<li>This notebook assumes you are running inside 0.6 Kubeflow deployed on GKE following the <a href="https://www.kubeflow.org/docs/gke/deploy/">GKE instructions</a>
</li>
<li>If you are running somewhere other than GKE you will need to modify the notebook to use a different docker registry or else configure Kubeflow to work with GCR.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Verify-we-have-a-GCP-account">
<a class="anchor" href="#Verify-we-have-a-GCP-account" aria-hidden="true"><span class="octicon octicon-link"></span></a>Verify we have a GCP account<a class="anchor-link" href="#Verify-we-have-a-GCP-account"> </a>
</h3>
<ul>
<li>The cell below checks that this notebook was spawned with credentials to access GCP</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">oauth2client.client</span> <span class="kn">import</span> <span class="n">GoogleCredentials</span>
<span class="n">credentials</span> <span class="o">=</span> <span class="n">GoogleCredentials</span><span class="o">.</span><span class="n">get_application_default</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install-Required-Libraries">
<a class="anchor" href="#Install-Required-Libraries" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install Required Libraries<a class="anchor-link" href="#Install-Required-Libraries"> </a>
</h2>
<p>Import the libraries required to train this model.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">notebook_setup</span>
<span class="n">notebook_setup</span><span class="o">.</span><span class="n">notebook_setup</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>pip installing requirements.txt
pip installing KFP https://storage.googleapis.com/ml-pipeline/release/0.1.32/kfp.tar.gz
pip installing fairing git+git://github.com/kubeflow/fairing.git@9b0d4ed4796ba349ac6067bbd802ff1d6454d015
Configure docker credentials
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Import the python libraries we will use</li>
<li>We add a comment "fairing:include-cell" to tell the kubefow fairing preprocessor to keep this cell when converting to python code later</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># fairing:include-cell</span>
<span class="kn">import</span> <span class="nn">fire</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">nbconvert</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_regression</span>
<span class="kn">from</span> <span class="nn">kubeflow.metadata</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">retrying</span>
<span class="kn">import</span> <span class="nn">urllib3</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Imports not to be included in the built docker image</span>
<span class="kn">import</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">kfp</span>
<span class="kn">import</span> <span class="nn">kfp.components</span> <span class="k">as</span> <span class="nn">comp</span>
<span class="kn">import</span> <span class="nn">kfp.gcp</span> <span class="k">as</span> <span class="nn">gcp</span>
<span class="kn">import</span> <span class="nn">kfp.dsl</span> <span class="k">as</span> <span class="nn">dsl</span>
<span class="kn">import</span> <span class="nn">kfp.compiler</span> <span class="k">as</span> <span class="nn">compiler</span>
<span class="kn">from</span> <span class="nn">kubernetes</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">k8s_client</span>
<span class="kn">from</span> <span class="nn">kubeflow</span> <span class="kn">import</span> <span class="n">fairing</span>   
<span class="kn">from</span> <span class="nn">kubeflow.fairing.builders</span> <span class="kn">import</span> <span class="n">append</span>
<span class="kn">from</span> <span class="nn">kubeflow.fairing.deployers</span> <span class="kn">import</span> <span class="n">job</span>
<span class="kn">from</span> <span class="nn">kubeflow.fairing.preprocessors.converted_notebook</span> <span class="kn">import</span> <span class="n">ConvertNotebookPreprocessorWithFire</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Code-to-train-and-predict">
<a class="anchor" href="#Code-to-train-and-predict" aria-hidden="true"><span class="octicon octicon-link"></span></a>Code to train and predict<a class="anchor-link" href="#Code-to-train-and-predict"> </a>
</h2>
<ul>
<li>In the cells below we define some functions to generate data and train a model</li>
<li>These functions could just as easily be defined in a separate python module</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># fairing:include-cell</span>
<span class="k">def</span> <span class="nf">read_synthetic_input</span><span class="p">(</span><span class="n">test_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
    <span class="sd">"""generate synthetic data and split it into train and test."""</span>
    <span class="c1"># generate regression dataset</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_regression</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">train_X</span><span class="p">,</span> <span class="n">test_X</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">test_y</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span>
                                                      <span class="n">y</span><span class="p">,</span>
                                                      <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span>
                                                      <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">()</span>
    <span class="n">train_X</span> <span class="o">=</span> <span class="n">imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_X</span><span class="p">)</span>
    <span class="n">test_X</span> <span class="o">=</span> <span class="n">imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_X</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">train_X</span><span class="p">,</span> <span class="n">train_y</span><span class="p">),</span> <span class="p">(</span><span class="n">test_X</span><span class="p">,</span> <span class="n">test_y</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># fairing:include-cell</span>
<span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">train_X</span><span class="p">,</span>
                <span class="n">train_y</span><span class="p">,</span>
                <span class="n">test_X</span><span class="p">,</span>
                <span class="n">test_y</span><span class="p">,</span>
                <span class="n">n_estimators</span><span class="p">,</span>
                <span class="n">learning_rate</span><span class="p">):</span>
    <span class="sd">"""Train the model using XGBRegressor."""</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_X</span><span class="p">,</span>
            <span class="n">train_y</span><span class="p">,</span>
            <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
            <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">test_X</span><span class="p">,</span> <span class="n">test_y</span><span class="p">)])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Best RMSE on eval: </span><span class="si">%.2f</span><span class="s2"> with </span><span class="si">%d</span><span class="s2"> rounds"</span><span class="p">,</span>
               <span class="n">model</span><span class="o">.</span><span class="n">best_score</span><span class="p">,</span>
               <span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="k">def</span> <span class="nf">eval_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_X</span><span class="p">,</span> <span class="n">test_y</span><span class="p">):</span>
    <span class="sd">"""Evaluate the model performance."""</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_X</span><span class="p">)</span>
    <span class="n">mae</span><span class="o">=</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">test_y</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"mean_absolute_error=</span><span class="si">%.2f</span><span class="s2">"</span><span class="p">,</span> <span class="n">mae</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mae</span>

<span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_file</span><span class="p">):</span>
    <span class="sd">"""Save XGBoost model for serving."""</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Model export success: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_workspace</span><span class="p">():</span>
    <span class="n">METADATA_STORE_HOST</span> <span class="o">=</span> <span class="s2">"metadata-grpc-service.kubeflow"</span> <span class="c1"># default DNS of Kubeflow Metadata gRPC serivce.</span>
    <span class="n">METADATA_STORE_PORT</span> <span class="o">=</span> <span class="mi">8080</span>
    <span class="k">return</span> <span class="n">metadata</span><span class="o">.</span><span class="n">Workspace</span><span class="p">(</span>
        <span class="n">store</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">grpc_host</span><span class="o">=</span><span class="n">METADATA_STORE_HOST</span><span class="p">,</span> <span class="n">grpc_port</span><span class="o">=</span><span class="n">METADATA_STORE_PORT</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"xgboost-synthetic"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"workspace for xgboost-synthetic artifacts and executions"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Wrap-Training-and-Prediction-in-a-class">
<a class="anchor" href="#Wrap-Training-and-Prediction-in-a-class" aria-hidden="true"><span class="octicon octicon-link"></span></a>Wrap Training and Prediction in a class<a class="anchor-link" href="#Wrap-Training-and-Prediction-in-a-class"> </a>
</h2>
<ul>
<li>In the cell below we wrap training and prediction in a class</li>
<li>A class provides the structure we will need to eventually use kubeflow fairing to launch separate training jobs and/or deploy the model on Kubernetes</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># fairing:include-cell</span>
<span class="k">class</span> <span class="nc">ModelServe</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">"MODEL_FILE"</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"model_file not supplied; checking environment variable"</span><span class="p">)</span>
                <span class="n">model_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"MODEL_FILE"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"model_file not supplied; using the default"</span><span class="p">)</span>
                <span class="n">model_file</span> <span class="o">=</span> <span class="s2">"mockup-model.dat"</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span> <span class="o">=</span> <span class="n">model_file</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"model_file=</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_workspace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_execution</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">(</span><span class="n">train_X</span><span class="p">,</span> <span class="n">train_y</span><span class="p">),</span> <span class="p">(</span><span class="n">test_X</span><span class="p">,</span> <span class="n">test_y</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_synthetic_input</span><span class="p">()</span>
        
        <span class="c1"># Here we use Kubeflow's metadata library to record information</span>
        <span class="c1"># about the training run to Kubeflow's metadata store.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exec</span><span class="o">.</span><span class="n">log_input</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">DataSet</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">"xgboost synthetic data"</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"synthetic-data"</span><span class="p">,</span>
            <span class="n">owner</span><span class="o">=</span><span class="s2">"someone@kubeflow.org"</span><span class="p">,</span>
            <span class="n">uri</span><span class="o">=</span><span class="s2">"file://path/to/dataset"</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="s2">"v1.0.0"</span><span class="p">))</span>
        
        <span class="n">model</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">train_X</span><span class="p">,</span>
                          <span class="n">train_y</span><span class="p">,</span>
                          <span class="n">test_X</span><span class="p">,</span>
                          <span class="n">test_y</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>

        <span class="n">mae</span> <span class="o">=</span> <span class="n">eval_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_X</span><span class="p">,</span> <span class="n">test_y</span><span class="p">)</span>
        
        <span class="c1"># Here we log metrics about the model to Kubeflow's metadata store.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exec</span><span class="o">.</span><span class="n">log_output</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">Metrics</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"xgboost-synthetic-traing-eval"</span><span class="p">,</span>
            <span class="n">owner</span><span class="o">=</span><span class="s2">"someone@kubeflow.org"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">"training evaluation for xgboost synthetic"</span><span class="p">,</span>
            <span class="n">uri</span><span class="o">=</span><span class="s2">"gcs://path/to/metrics"</span><span class="p">,</span>
            <span class="n">metrics_type</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">Metrics</span><span class="o">.</span><span class="n">VALIDATION</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="p">{</span><span class="s2">"mean_absolute_error"</span><span class="p">:</span> <span class="n">mae</span><span class="p">}))</span>
        
        <span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exec</span><span class="o">.</span><span class="n">log_output</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"housing-price-model"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">"housing price prediction model using synthetic data"</span><span class="p">,</span>
            <span class="n">owner</span><span class="o">=</span><span class="s2">"someone@kubeflow.org"</span><span class="p">,</span>
            <span class="n">uri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="s2">"linear_regression"</span><span class="p">,</span>
            <span class="n">training_framework</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"xgboost"</span><span class="p">,</span>
                <span class="s2">"version"</span><span class="p">:</span> <span class="s2">"0.9.0"</span>
            <span class="p">},</span>
            <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">"learning_rate"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                <span class="s2">"n_estimators"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span>
            <span class="p">},</span>
            <span class="n">version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s2">"T"</span><span class="p">)))</span>
        
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">):</span>
        <span class="sd">"""Predict using the model for given ndarray.</span>
<span class="sd">        </span>
<span class="sd">        The predict signature should match the syntax expected by Seldon Core</span>
<span class="sd">        https://github.com/SeldonIO/seldon-core so that we can use</span>
<span class="sd">        Seldon h to wrap it a model server and deploy it on Kubernetes</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="p">)</span>
        <span class="c1"># Do any preprocessing</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
        <span class="c1"># Do any postprocessing</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">prediction</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">prediction</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">1</span><span class="p">)]]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">workspace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workspace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_workspace</span> <span class="o">=</span> <span class="n">create_workspace</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workspace</span>
    
    <span class="k">def</span> <span class="nf">create_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                
        <span class="n">r</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span>
            <span class="n">workspace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"xgboost-synthetic-faring-run"</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s2">"T"</span><span class="p">),</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">"a notebook run"</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">metadata</span><span class="o">.</span><span class="n">Execution</span><span class="p">(</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">"execution"</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s2">"T"</span><span class="p">),</span>
            <span class="n">workspace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span>
            <span class="n">run</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">"execution for training xgboost-synthetic"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Train-your-Model-Locally">
<a class="anchor" href="#Train-your-Model-Locally" aria-hidden="true"><span class="octicon octicon-link"></span></a>Train your Model Locally<a class="anchor-link" href="#Train-your-Model-Locally"> </a>
</h2>
<ul>
<li>Train your model locally inside your notebook</li>
<li>To train locally we just instatiante the ModelServe class and then call train</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ModelServe</span><span class="p">(</span><span class="n">model_file</span><span class="o">=</span><span class="s2">"mockup-model.dat"</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>MetadataStore with gRPC connection initialized
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>model_file=mockup-model.dat
[23:44:47] WARNING: /workspace/src/objective/regression_obj.cu:152: reg:linear is now deprecated in favor of reg:squarederror.
[0]	validation_0-rmse:134.005
Will train until validation_0-rmse hasn't improved in 40 rounds.
[1]	validation_0-rmse:129.102
[2]	validation_0-rmse:124.39
[3]	validation_0-rmse:119.218
[4]	validation_0-rmse:114.096
[5]	validation_0-rmse:109.494
[6]	validation_0-rmse:107.101
[7]	validation_0-rmse:103.463
[8]	validation_0-rmse:100.657
[9]	validation_0-rmse:96.576
[10]	validation_0-rmse:94.8884
[11]	validation_0-rmse:91.7095
[12]	validation_0-rmse:90.7389
[13]	validation_0-rmse:88.1934
[14]	validation_0-rmse:86.1535
[15]	validation_0-rmse:84.8222
[16]	validation_0-rmse:83.5818
[17]	validation_0-rmse:81.6697
[18]	validation_0-rmse:80.2789
[19]	validation_0-rmse:79.4583
[20]	validation_0-rmse:78.4213
[21]	validation_0-rmse:77.0478
[22]	validation_0-rmse:75.3792
[23]	validation_0-rmse:73.9913
[24]	validation_0-rmse:73.2026
[25]	validation_0-rmse:72.2079
[26]	validation_0-rmse:70.9489
[27]	validation_0-rmse:70.5206
[28]	validation_0-rmse:69.8641
[29]	validation_0-rmse:69.0409
[30]	validation_0-rmse:68.3776
[31]	validation_0-rmse:67.2776
[32]	validation_0-rmse:66.7612
[33]	validation_0-rmse:65.9548
[34]	validation_0-rmse:65.5048
[35]	validation_0-rmse:64.8582
[36]	validation_0-rmse:64.118
[37]	validation_0-rmse:63.5615
[38]	validation_0-rmse:63.2716
[39]	validation_0-rmse:62.9765
[40]	validation_0-rmse:62.3468
[41]	validation_0-rmse:62.0579
[42]	validation_0-rmse:61.9598
[43]	validation_0-rmse:61.6452
[44]	validation_0-rmse:61.2468
[45]	validation_0-rmse:60.7332
[46]	validation_0-rmse:60.6493
[47]	validation_0-rmse:60.2032
[48]	validation_0-rmse:59.9972
[49]	validation_0-rmse:59.5956
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>mean_absolute_error=47.22
Model export success: mockup-model.dat
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Best RMSE on eval: %.2f with %d rounds 59.595573 50
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Predict-locally">
<a class="anchor" href="#Predict-locally" aria-hidden="true"><span class="octicon octicon-link"></span></a>Predict locally<a class="anchor-link" href="#Predict-locally"> </a>
</h2>
<ul>
<li>Run prediction inside the notebook using the newly created model</li>
<li>To run prediction we just invoke redict</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">train_X</span><span class="p">,</span> <span class="n">train_y</span><span class="p">),</span> <span class="p">(</span><span class="n">test_X</span><span class="p">,</span> <span class="n">test_y</span><span class="p">)</span> <span class="o">=</span><span class="n">read_synthetic_input</span><span class="p">()</span>

<span class="n">ModelServe</span><span class="p">()</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_X</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>MetadataStore with gRPC connection initialized
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>model_file not supplied; using the default
model_file=mockup-model.dat
[23:44:47] WARNING: /workspace/src/objective/regression_obj.cu:152: reg:linear is now deprecated in favor of reg:squarederror.
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[[-30.6968994140625, 45.884098052978516]]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Use-Kubeflow-Fairing-to-Launch-a-K8s-Job-to-train-your-model">
<a class="anchor" href="#Use-Kubeflow-Fairing-to-Launch-a-K8s-Job-to-train-your-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Use Kubeflow Fairing to Launch a K8s Job to train your model<a class="anchor-link" href="#Use-Kubeflow-Fairing-to-Launch-a-K8s-Job-to-train-your-model"> </a>
</h2>
<ul>
<li>Now that we have trained a model locally we can use Kubeflow fairing to<ol>
<li>Launch a Kubernetes job to train the model</li>
<li>Deploy the model on Kubernetes</li>
</ol>
</li>
<li>
<p>Launching a separate Kubernetes job to train the model has the following advantages</p>
<ul>
<li>You can leverage Kubernetes to run multiple training jobs in parallel </li>
<li>You can run long running jobs without blocking your kernel</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Configure-The-Docker-Registry-For-Kubeflow-Fairing">
<a class="anchor" href="#Configure-The-Docker-Registry-For-Kubeflow-Fairing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure The Docker Registry For Kubeflow Fairing<a class="anchor-link" href="#Configure-The-Docker-Registry-For-Kubeflow-Fairing"> </a>
</h3>
<ul>
<li>In order to build docker images from your notebook we need a docker registry where the images will be stored</li>
<li>Below you set some variables specifying a <a href="https://cloud.google.com/container-registry/docs/">GCR container registry</a>
</li>
<li>Kubeflow Fairing provides a utility function to guess the name of your GCP project</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Setting up google container repositories (GCR) for storing output containers</span>
<span class="c1"># You can use any docker container registry istead of GCR</span>
<span class="n">GCP_PROJECT</span> <span class="o">=</span> <span class="n">fairing</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">gcp</span><span class="o">.</span><span class="n">guess_project_name</span><span class="p">()</span>
<span class="n">DOCKER_REGISTRY</span> <span class="o">=</span> <span class="s1">'gcr.io/</span><span class="si">{}</span><span class="s1">/fairing-job'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GCP_PROJECT</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Use-Kubeflow-fairing-to-build-the-docker-image">
<a class="anchor" href="#Use-Kubeflow-fairing-to-build-the-docker-image" aria-hidden="true"><span class="octicon octicon-link"></span></a>Use Kubeflow fairing to build the docker image<a class="anchor-link" href="#Use-Kubeflow-fairing-to-build-the-docker-image"> </a>
</h2>
<ul>
<li>First you will use kubeflow fairing's kaniko builder to build a docker image that includes all your dependencies<ul>
<li>You use kaniko because you want to be able to run <code>pip</code> to install dependencies</li>
<li>Kaniko gives you the flexibility to build images from Dockerfiles</li>
</ul>
</li>
<li>kaniko, however, can be slow</li>
<li>so you will build a base image using Kaniko and then every time your code changes you will just build an image
starting from your base image and adding your code to it</li>
<li>you use the kubeflow fairing build to enable these fast rebuilds</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># TODO(https://github.com/kubeflow/fairing/issues/426): We should get rid of this once the default </span>
<span class="c1"># Kaniko image is updated to a newer image than 0.7.0.</span>
<span class="kn">from</span> <span class="nn">kubeflow.fairing</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="n">constants</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">KANIKO_IMAGE</span> <span class="o">=</span> <span class="s2">"gcr.io/kaniko-project/executor:v0.14.0"</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">kubeflow.fairing.builders</span> <span class="kn">import</span> <span class="n">cluster</span>

<span class="c1"># output_map is a map of extra files to add to the notebook.</span>
<span class="c1"># It is a map from source location to the location inside the context.</span>
<span class="n">output_map</span> <span class="o">=</span>  <span class="p">{</span>
    <span class="s2">"Dockerfile"</span><span class="p">:</span> <span class="s2">"Dockerfile"</span><span class="p">,</span>
    <span class="s2">"requirements.txt"</span><span class="p">:</span> <span class="s2">"requirements.txt"</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ConvertNotebookPreprocessorWithFire</span><span class="p">(</span><span class="n">class_name</span><span class="o">=</span><span class="s1">'ModelServe'</span><span class="p">,</span> <span class="n">notebook_file</span><span class="o">=</span><span class="s1">'build-train-deploy.ipynb'</span><span class="p">,</span>
                                                   <span class="n">output_map</span><span class="o">=</span><span class="n">output_map</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">input_files</span><span class="p">:</span>
    <span class="n">preprocessor</span><span class="o">.</span><span class="n">input_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="n">input_files</span><span class="o">=</span><span class="p">[</span><span class="s2">"xgboost_util.py"</span><span class="p">,</span> <span class="s2">"mockup-model.dat"</span><span class="p">]</span>
<span class="n">preprocessor</span><span class="o">.</span><span class="n">input_files</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">input_files</span><span class="p">])</span>
<span class="n">preprocessor</span><span class="o">.</span><span class="n">preprocess</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Converting build-train-deploy.ipynb to build-train-deploy.py
Creating entry point for the class name ModelServe
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[PosixPath('build-train-deploy.py'), 'xgboost_util.py', 'mockup-model.dat']</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Build-the-base-image">
<a class="anchor" href="#Build-the-base-image" aria-hidden="true"><span class="octicon octicon-link"></span></a>Build the base image<a class="anchor-link" href="#Build-the-base-image"> </a>
</h3>
<ul>
<li>You use cluster_builder to build the base image</li>
<li>You only need to perform this again if we change our Docker image or the dependencies we need to install</li>
<li>ClusterBuilder takes as input the DockerImage to use as a base image</li>
<li>You should use the same Jupyter image that you are using for your notebook server so that your environment will be
the same when you launch Kubernetes jobs</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Use a stock jupyter image as our base image</span>
<span class="c1"># TODO(jlewi): Should we try to use the downward API to default to the image we are running in?</span>
<span class="n">base_image</span> <span class="o">=</span> <span class="s2">"gcr.io/kubeflow-images-public/tensorflow-1.14.0-notebook-cpu:v0.7.0"</span>
<span class="c1"># We use a custom Dockerfile </span>
<span class="n">cluster_builder</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">ClusterBuilder</span><span class="p">(</span><span class="n">registry</span><span class="o">=</span><span class="n">DOCKER_REGISTRY</span><span class="p">,</span>
                                                 <span class="n">base_image</span><span class="o">=</span><span class="n">base_image</span><span class="p">,</span>
                                                 <span class="n">preprocessor</span><span class="o">=</span><span class="n">preprocessor</span><span class="p">,</span>
                                                 <span class="n">dockerfile_path</span><span class="o">=</span><span class="s2">"Dockerfile"</span><span class="p">,</span>
                                                 <span class="n">pod_spec_mutators</span><span class="o">=</span><span class="p">[</span><span class="n">fairing</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">gcp</span><span class="o">.</span><span class="n">add_gcp_credentials_if_exists</span><span class="p">],</span>
                                                 <span class="n">context_source</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">gcs_context</span><span class="o">.</span><span class="n">GCSContextSource</span><span class="p">())</span>
<span class="n">cluster_builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Building image using cluster builder.
Creating docker context: /tmp/fairing_context_n34sz0lr
Converting build-train-deploy.ipynb to build-train-deploy.py
Creating entry point for the class name ModelServe
Not able to find gcp credentials secret: user-gcp-sa
Trying workload identity service account: default-editor
Waiting for fairing-builder-dcbz2-lqzjg to start...
Waiting for fairing-builder-dcbz2-lqzjg to start...
Waiting for fairing-builder-dcbz2-lqzjg to start...
Pod started running True
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>ERROR: logging before flag.Parse: E0226 23:44:52.505936       1 metadata.go:241] Failed to unmarshal scopes: invalid character 'h' looking for beginning of value
<span class="ansi-cyan-fg">INFO</span>[0002] Resolved base name gcr.io/kubeflow-images-public/tensorflow-1.14.0-notebook-cpu:v0.7.0 to gcr.io/kubeflow-images-public/tensorflow-1.14.0-notebook-cpu:v0.7.0
<span class="ansi-cyan-fg">INFO</span>[0002] Resolved base name gcr.io/kubeflow-images-public/tensorflow-1.14.0-notebook-cpu:v0.7.0 to gcr.io/kubeflow-images-public/tensorflow-1.14.0-notebook-cpu:v0.7.0
<span class="ansi-cyan-fg">INFO</span>[0002] Downloading base image gcr.io/kubeflow-images-public/tensorflow-1.14.0-notebook-cpu:v0.7.0
<span class="ansi-cyan-fg">INFO</span>[0002] Error while retrieving image from cache: getting file info: stat /cache/sha256:fe174faf7c477bc3dae796b067d98ac3f0d31e8075007a1146f86d13f2c98e13: no such file or directory
<span class="ansi-cyan-fg">INFO</span>[0002] Downloading base image gcr.io/kubeflow-images-public/tensorflow-1.14.0-notebook-cpu:v0.7.0
<span class="ansi-cyan-fg">INFO</span>[0003] Built cross stage deps: map[]
<span class="ansi-cyan-fg">INFO</span>[0003] Downloading base image gcr.io/kubeflow-images-public/tensorflow-1.14.0-notebook-cpu:v0.7.0
<span class="ansi-cyan-fg">INFO</span>[0003] Error while retrieving image from cache: getting file info: stat /cache/sha256:fe174faf7c477bc3dae796b067d98ac3f0d31e8075007a1146f86d13f2c98e13: no such file or directory
<span class="ansi-cyan-fg">INFO</span>[0003] Downloading base image gcr.io/kubeflow-images-public/tensorflow-1.14.0-notebook-cpu:v0.7.0
<span class="ansi-cyan-fg">INFO</span>[0003] Using files from context: [/kaniko/buildcontext/requirements.txt]
<span class="ansi-cyan-fg">INFO</span>[0003] Checking for cached layer gcr.io/kubeflow-ci/fairing-job/fairing-job/cache:233bc2f24de09b29aa4c12d0f5adcc3098286c3c35eb0b4864fa00f73d8b9d2c...
<span class="ansi-cyan-fg">INFO</span>[0003] Using caching version of cmd: COPY requirements.txt .
<span class="ansi-cyan-fg">INFO</span>[0003] cmd: USER
<span class="ansi-cyan-fg">INFO</span>[0003] Checking for cached layer gcr.io/kubeflow-ci/fairing-job/fairing-job/cache:1acac4c9cb73d1b18003ae6076fd264e37af3983927234122784b04452b9b44e...
<span class="ansi-cyan-fg">INFO</span>[0004] Using caching version of cmd: RUN pip3 --no-cache-dir install -r requirements.txt
<span class="ansi-cyan-fg">INFO</span>[0004] cmd: USER
<span class="ansi-cyan-fg">INFO</span>[0004] Skipping unpacking as no commands require it.
<span class="ansi-cyan-fg">INFO</span>[0004] Taking snapshot of full filesystem...
<span class="ansi-cyan-fg">INFO</span>[0004] COPY requirements.txt .
<span class="ansi-cyan-fg">INFO</span>[0004] Found cached layer, extracting to filesystem
<span class="ansi-cyan-fg">INFO</span>[0004] extractedFiles: [/tf/requirements.txt / /tf]
<span class="ansi-cyan-fg">INFO</span>[0004] Taking snapshot of files...
<span class="ansi-cyan-fg">INFO</span>[0004] USER root
<span class="ansi-cyan-fg">INFO</span>[0004] cmd: USER
<span class="ansi-cyan-fg">INFO</span>[0004] No files changed in this command, skipping snapshotting.
<span class="ansi-cyan-fg">INFO</span>[0004] RUN pip3 --no-cache-dir install -r requirements.txt
<span class="ansi-cyan-fg">INFO</span>[0004] Found cached layer, extracting to filesystem
<span class="ansi-cyan-fg">INFO</span>[0032] Taking snapshot of files...
<span class="ansi-cyan-fg">INFO</span>[0070] USER jovyan
<span class="ansi-cyan-fg">INFO</span>[0070] cmd: USER
<span class="ansi-cyan-fg">INFO</span>[0070] No files changed in this command, skipping snapshotting.
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Build-the-actual-image">
<a class="anchor" href="#Build-the-actual-image" aria-hidden="true"><span class="octicon octicon-link"></span></a>Build the actual image<a class="anchor-link" href="#Build-the-actual-image"> </a>
</h3>
<p>Here you use the append builder to add your code to the base image</p>
<ul>
<li>
<p>Calling preprocessor.preprocess() converts your notebook file to a python file</p>
<ul>
<li>You are using the <a href="https://github.com/kubeflow/fairing/blob/master/fairing/preprocessors/converted_notebook.py#L85">ConvertNotebookPreprocessorWithFire</a> </li>
<li>
<p>This preprocessor converts ipynb files to py files by doing the following</p>
<ol>
<li>Removing all cells which don't have a comment <code># fairing:include-cell</code>
</li>
<li>Using <a href="https://github.com/google/python-fire">python-fire</a> to add entry points for the class specified in the constructor </li>
</ol>
</li>
<li>
<p>Call preprocess() will create the file build-train-deploy.py</p>
</li>
</ul>
</li>
<li>
<p>You use the AppendBuilder to rapidly build a new docker image by quickly adding some files to an existing docker image</p>
<ul>
<li>The AppendBuilder is super fast so its very convenient for rebuilding your images as you iterate on your code</li>
<li>The AppendBuilder will add the converted notebook, build-train-deploy.py, along with any files specified in <code>preprocessor.input_files</code> to <code>/app</code> in the newly created image</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preprocessor</span><span class="o">.</span><span class="n">preprocess</span><span class="p">()</span>

<span class="n">builder</span> <span class="o">=</span> <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="o">.</span><span class="n">AppendBuilder</span><span class="p">(</span><span class="n">registry</span><span class="o">=</span><span class="n">DOCKER_REGISTRY</span><span class="p">,</span>
                                      <span class="n">base_image</span><span class="o">=</span><span class="n">cluster_builder</span><span class="o">.</span><span class="n">image_tag</span><span class="p">,</span> <span class="n">preprocessor</span><span class="o">=</span><span class="n">preprocessor</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Converting build-train-deploy.ipynb to build-train-deploy.py
Creating entry point for the class name ModelServe
Building image using Append builder...
Creating docker context: /tmp/fairing_context_x4g0orab
Converting build-train-deploy.ipynb to build-train-deploy.py
Creating entry point for the class name ModelServe
build-train-deploy.py already exists in Fairing context, skipping...
Loading Docker credentials for repository 'gcr.io/kubeflow-ci/fairing-job/fairing-job:F47EE88D'
Invoking 'docker-credential-gcloud' to obtain Docker credentials.
Successfully obtained Docker credentials.
Image successfully built in 2.249176573008299s.
Pushing image gcr.io/kubeflow-ci/fairing-job/fairing-job:BDE79D77...
Loading Docker credentials for repository 'gcr.io/kubeflow-ci/fairing-job/fairing-job:BDE79D77'
Invoking 'docker-credential-gcloud' to obtain Docker credentials.
Successfully obtained Docker credentials.
Uploading gcr.io/kubeflow-ci/fairing-job/fairing-job:BDE79D77
Layer sha256:8832e37735788665026956430021c6d1919980288c66c4526502965aeb5ac006 exists, skipping
Layer sha256:b4ecb6928817c974946ba93ffc5ce60de886457eb57955dae9d7bc8facfb690a exists, skipping
Layer sha256:9269cef1ab8b202433fe1dfbfbdf4649926d70d7a8b94f0324421bda79b917fa exists, skipping
Layer sha256:d77b634303a107b22366d05d1071bf79e7d2a27b3d6db1fb726fcfd5dd5f9831 exists, skipping
Layer sha256:5bd1cb59702536c10e96bb14e54846922c9b257580d4e2c733076a922525240b exists, skipping
Layer sha256:7babe47a4c402afbe26f10dffceb85be7bfd2072a96b816814503f41ce9c5273 exists, skipping
Layer sha256:21a7832aeb8625dc8228ceb115a28222f87e0fbce61b2588c42a2cce7a3a63d6 exists, skipping
Layer sha256:107cba84ef3d72ed995c76c7a4f60ba5613f58b029ab7e42ac20ece99bec88b1 exists, skipping
Layer sha256:a31c3b1caad473a474d574283741f880e37c708cc06ee620d3e93fa602125ee0 exists, skipping
Layer sha256:92d24c89f5bc70958385728755b042a5a45bddf2f997de80e84d1161f43ba316 exists, skipping
Layer sha256:e590ee7edf442435692956d6fed54190416a217147a50c63e73a6a78d15bec84 exists, skipping
Layer sha256:96685dce34a0d24bf69741972441398cffbed89aed4f40e3c063176c59a3c81c exists, skipping
Layer sha256:daa5c419d33d51d1730ea530f4f7335640f5bb42856f319c63a1a521aee368c1 exists, skipping
Layer sha256:016724bbd2c9643f24eff7c1e86d9202d7c04caddd7fdd4375a77e3998ce8203 exists, skipping
Layer sha256:b5494e32d0131350be270a54399cee65934e90d3c2df87a83757903e627813b2 exists, skipping
Layer sha256:823f4685c03b26a545ca41dcdca1e782ad5e52cf85bac03113edaa6aebdca1b3 exists, skipping
Layer sha256:777cec03b3e23c21f8cf78f07812cc83dd7f352719226f27f361c5b706f6a93f exists, skipping
Layer sha256:dc2840b4417186d66a29d64a039ac164be95929211d808294d36acae9301fc6b exists, skipping
Layer sha256:5e671b828b2af02924968841e5d12084fa78e8722e9510402aaee80dc5d7a6db exists, skipping
Layer sha256:5bac0c144f6e0b7082e3691da95d3f057ee0be0735e9efca76096da59cfd1786 exists, skipping
Layer sha256:5b7339215d1d5f8e68622d584a224f60339f5bef41dbd74330d081e912f0cddd exists, skipping
Layer sha256:35daced67e5901b8de4a92bca9fdc67c8593d400aae483591987442f54c87d0a exists, skipping
Layer sha256:330a9002e0b4aa1e27d3628dd3f02ff9a39d25745b8f2f219b06e3725153ffc0 exists, skipping
Layer sha256:4e8a6b90828e0d339f646d723df8720ffa17c0ffb905f8f009faf1be320ab5d9 exists, skipping
Layer sha256:2b940936f9933b7737cf407f2149dd7393998d7a0bee5acf1c4a57b0487cef79 exists, skipping
Layer sha256:d684674aa1a4d080be26286fd9356f573b80d2448599392e3dcf3c61ce98a0f0 exists, skipping
Layer sha256:68543864d6442a851eaff0500161b92e4a151051cf7ed2649b3790a3f876bada exists, skipping
Layer sha256:21640f54008ccbfc0d100246633f8e6f18f918a0566561f61aebbda785321e56 exists, skipping
Layer sha256:f44c204b040238da05a21af1fd8543ea95f1e9249fac34b3b65217e38815568d exists, skipping
Layer sha256:b054a26005b7f3b032577f811421fab5ec3b42ce45a4012dfa00cf6ed6191b0f exists, skipping
Layer sha256:14ca88e9f6723ce82bc14b241cda8634f6d19677184691d086662641ab96fe68 exists, skipping
Layer sha256:e3ab47ad84d9e11c5fad45791ce00ec5b5f3b7f1ae61a5fab17eb44c399d910f exists, skipping
Layer sha256:01ad04a655b291ed8502f23f5b8c73d94475763e9b3cdbf6d1107f7879aadac6 exists, skipping
Layer sha256:4b9d9f2fa2a2b168f0a49fcd3074c885ab1ca2c507848f7b2e3cee8104f1f7c3 exists, skipping
Layer sha256:5bd2e6f0de430cd3936eec59afb6cf466b052344fe4348ac33a48ac903b661e2 exists, skipping
Layer sha256:15bca5bd6fdc1b1ac156de08ce3b0f57760b345556b64017d1be5cc7c95e5e5b pushed.
Layer sha256:d23f2bdcc84f066126b083288f75d140d58fc252618bda5bf05cb9696a183958 pushed.
Finished upload of: gcr.io/kubeflow-ci/fairing-job/fairing-job:BDE79D77
Pushed image gcr.io/kubeflow-ci/fairing-job/fairing-job:BDE79D77 in 2.74867532402277s.
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Launch-the-K8s-Job">
<a class="anchor" href="#Launch-the-K8s-Job" aria-hidden="true"><span class="octicon octicon-link"></span></a>Launch the K8s Job<a class="anchor-link" href="#Launch-the-K8s-Job"> </a>
</h2>
<ul>
<li>You can use kubeflow fairing to easily launch a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/">Kubernetes job</a> to invoke code</li>
<li>You use fairings Kubernetes job library to build a Kubernetes job<ul>
<li>You use pod mutators to attach GCP credentials to the pod</li>
<li>You can also use pod mutators to attch PVCs</li>
</ul>
</li>
<li>Since the <a href="https://github.com/kubeflow/fairing/blob/master/fairing/preprocessors/converted_notebook.py#L85">ConvertNotebookPreprocessorWithFire</a> is using <a href="https://github.com/google/python-fire">python-fire</a> you can easily invoke any method inside the ModelServe class just by configuring the command invoked by the Kubernetes job<ul>
<li>In the cell below you extend the command to include <code>train</code> as an argument because you want to invoke the train
function</li>
</ul>
</li>
</ul>
<p><strong>Note</strong> When you invoke train_deployer.deploy; kubeflow fairing will stream the logs from the Kubernetes job. The job will initially show some connection errors because the job will try to connect to the metadataserver. You can ignore these errors; the job will retry until its able to connect and then continue</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pod_spec</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">generate_pod_spec</span><span class="p">()</span>
<span class="n">train_deployer</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span><span class="n">cleanup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">pod_spec_mutators</span><span class="o">=</span><span class="p">[</span>
                             <span class="n">fairing</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">gcp</span><span class="o">.</span><span class="n">add_gcp_credentials_if_exists</span><span class="p">])</span>

<span class="c1"># Add command line arguments</span>
<span class="n">pod_spec</span><span class="o">.</span><span class="n">containers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">"train"</span><span class="p">])</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">train_deployer</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">pod_spec</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Not able to find gcp credentials secret: user-gcp-sa
Trying workload identity service account: default-editor
The job fairing-job-qwdlb launched.
Waiting for fairing-job-qwdlb-67ddb to start...
Waiting for fairing-job-qwdlb-67ddb to start...
Waiting for fairing-job-qwdlb-67ddb to start...
Pod started running True
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2020-02-26 23:48:04.056153: W tensorflow/stream_executor/platform/default/dso_loader.cc:55] Could not load dynamic library 'libnvinfer.so.6'; dlerror: libnvinfer.so.6: cannot open shared object file: No such file or directory
2020-02-26 23:48:04.056318: W tensorflow/stream_executor/platform/default/dso_loader.cc:55] Could not load dynamic library 'libnvinfer_plugin.so.6'; dlerror: libnvinfer_plugin.so.6: cannot open shared object file: No such file or directory
2020-02-26 23:48:04.056332: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:30] Cannot dlopen some TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please make sure the missing libraries mentioned above are installed properly.
WARNING: Logging before flag parsing goes to stderr.
I0226 23:48:06.277673 140238089848640 metadata_store.py:80] MetadataStore with gRPC connection initialized
model_file not supplied; using the default
model_file=mockup-model.dat
[23:48:06] WARNING: /workspace/src/objective/regression_obj.cu:152: reg:linear is now deprecated in favor of reg:squarederror.
[0]	validation_0-rmse:106.201
Will train until validation_0-rmse hasn't improved in 40 rounds.
[1]	validation_0-rmse:102.289
[2]	validation_0-rmse:99.0904
[3]	validation_0-rmse:95.5223
[4]	validation_0-rmse:92.2357
[5]	validation_0-rmse:90.1649
[6]	validation_0-rmse:87.6004
[7]	validation_0-rmse:85.4127
[8]	validation_0-rmse:82.7163
[9]	validation_0-rmse:81.1641
[10]	validation_0-rmse:79.1006
[11]	validation_0-rmse:77.2564
[12]	validation_0-rmse:75.3755
[13]	validation_0-rmse:74.3393
[14]	validation_0-rmse:72.0505
[15]	validation_0-rmse:70.8315
[16]	validation_0-rmse:69.1124
[17]	validation_0-rmse:67.9681
[18]	validation_0-rmse:66.2094
[19]	validation_0-rmse:64.6999
[20]	validation_0-rmse:63.6925
[21]	validation_0-rmse:62.261
[22]	validation_0-rmse:60.887
[23]	validation_0-rmse:59.5543
[24]	validation_0-rmse:58.3673
[25]	validation_0-rmse:57.0439
[26]	validation_0-rmse:55.7172
[27]	validation_0-rmse:54.7011
[28]	validation_0-rmse:53.8976
[29]	validation_0-rmse:53.3325
[30]	validation_0-rmse:52.81
[31]	validation_0-rmse:51.8806
[32]	validation_0-rmse:50.9026
[33]	validation_0-rmse:50.0451
[34]	validation_0-rmse:49.2711
[35]	validation_0-rmse:48.6533
[36]	validation_0-rmse:47.8613
[37]	validation_0-rmse:47.5519
[38]	validation_0-rmse:46.9383
[39]	validation_0-rmse:46.7275
[40]	validation_0-rmse:46.1317
[41]	validation_0-rmse:45.7704
[42]	validation_0-rmse:45.4888
[43]	validation_0-rmse:44.8847
[44]	validation_0-rmse:44.5583
[45]	validation_0-rmse:43.9202
[46]	validation_0-rmse:43.7332
[47]	validation_0-rmse:43.2122
[48]	validation_0-rmse:43.0383
[49]	validation_0-rmse:42.7427
I0226 23:48:06.457567 140238089848640 build-train-deploy.py:100] mean_absolute_error=33.15
I0226 23:48:06.494030 140238089848640 build-train-deploy.py:106] Model export success: mockup-model.dat
Best RMSE on eval: %.2f with %d rounds 42.742691 50
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>You can use kubectl to inspect the job that fairing created</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>kubectl get <span class="nb">jobs</span> -l fairing-id<span class="o">={</span>train_deployer.job_id<span class="o">}</span> -o yaml
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>apiVersion: v1
items:
- apiVersion: batch/v1
  kind: Job
  metadata:
    creationTimestamp: "2020-02-26T23:47:21Z"
    generateName: fairing-job-
    labels:
      fairing-deployer: job
      fairing-id: 54d568cc-58f2-11ea-964d-46fd3ccc57c5
    name: fairing-job-qwdlb
    namespace: zhenghui
    resourceVersion: "11375571"
    selfLink: /apis/batch/v1/namespaces/zhenghui/jobs/fairing-job-qwdlb
    uid: 54d8d81b-58f2-11ea-a99d-42010a8000ac
  spec:
    backoffLimit: 0
    completions: 1
    parallelism: 1
    selector:
      matchLabels:
        controller-uid: 54d8d81b-58f2-11ea-a99d-42010a8000ac
    template:
      metadata:
        annotations:
          sidecar.istio.io/inject: "false"
        creationTimestamp: null
        labels:
          controller-uid: 54d8d81b-58f2-11ea-a99d-42010a8000ac
          fairing-deployer: job
          fairing-id: 54d568cc-58f2-11ea-964d-46fd3ccc57c5
          job-name: fairing-job-qwdlb
        name: fairing-deployer
      spec:
        containers:
        - command:
          - python
          - /app/build-train-deploy.py
          - train
          env:
          - name: FAIRING_RUNTIME
            value: "1"
          image: gcr.io/kubeflow-ci/fairing-job/fairing-job:BDE79D77
          imagePullPolicy: IfNotPresent
          name: fairing-job
          resources: {}
          securityContext:
            runAsUser: 0
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          workingDir: /app/
        dnsPolicy: ClusterFirst
        restartPolicy: Never
        schedulerName: default-scheduler
        securityContext: {}
        serviceAccount: default-editor
        serviceAccountName: default-editor
        terminationGracePeriodSeconds: 30
  status:
    completionTime: "2020-02-26T23:48:08Z"
    conditions:
    - lastProbeTime: "2020-02-26T23:48:08Z"
      lastTransitionTime: "2020-02-26T23:48:08Z"
      status: "True"
      type: Complete
    startTime: "2020-02-26T23:47:21Z"
    succeeded: 1
kind: List
metadata:
  resourceVersion: ""
  selfLink: ""
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Deploy-the-trained-model-to-Kubeflow-for-predictions">
<a class="anchor" href="#Deploy-the-trained-model-to-Kubeflow-for-predictions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Deploy the trained model to Kubeflow for predictions<a class="anchor-link" href="#Deploy-the-trained-model-to-Kubeflow-for-predictions"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Now that you have trained a model you can use kubeflow fairing to deploy it on Kubernetes</li>
<li>When you call deployer.deploy fairing will create a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Kubernetes Deployment</a> to serve your model</li>
<li>Kubeflow fairing uses the docker image you created earlier</li>
<li>The docker image you created contains your code and <a href="https://www.seldon.io/">Seldon core</a>
</li>
<li>Kubeflow fairing uses Seldon to wrap your prediction code, ModelServe.predict, in a REST and gRPC server</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">kubeflow.fairing.deployers</span> <span class="kn">import</span> <span class="n">serving</span>
<span class="n">pod_spec</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">generate_pod_spec</span><span class="p">()</span>

<span class="n">module_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">deployer</span> <span class="o">=</span> <span class="n">serving</span><span class="o">.</span><span class="n">serving</span><span class="o">.</span><span class="n">Serving</span><span class="p">(</span><span class="n">module_name</span> <span class="o">+</span> <span class="s2">".ModelServe"</span><span class="p">,</span>
                                   <span class="n">service_type</span><span class="o">=</span><span class="s2">"ClusterIP"</span><span class="p">,</span>
                                   <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">"app"</span><span class="p">:</span> <span class="s2">"mockup"</span><span class="p">})</span>
    
<span class="n">url</span> <span class="o">=</span> <span class="n">deployer</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">pod_spec</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Cluster endpoint: http://fairing-service-kkbtm.zhenghui.svc.cluster.local:5000/predict
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>You can use kubectl to inspect the deployment that fairing created</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>kubectl get deploy -o yaml <span class="o">{</span>deployer.deployment.metadata.name<span class="o">}</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    deployment.kubernetes.io/revision: "1"
  creationTimestamp: "2020-02-26T23:48:12Z"
  generateName: fairing-deployer-
  generation: 1
  labels:
    app: mockup
    fairing-deployer: serving
    fairing-id: 73532514-58f2-11ea-964d-46fd3ccc57c5
  name: fairing-deployer-p8xc9
  namespace: zhenghui
  resourceVersion: "11375642"
  selfLink: /apis/extensions/v1beta1/namespaces/zhenghui/deployments/fairing-deployer-p8xc9
  uid: 7354b5ec-58f2-11ea-a99d-42010a8000ac
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: mockup
      fairing-deployer: serving
      fairing-id: 73532514-58f2-11ea-964d-46fd3ccc57c5
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
      creationTimestamp: null
      labels:
        app: mockup
        fairing-deployer: serving
        fairing-id: 73532514-58f2-11ea-964d-46fd3ccc57c5
      name: fairing-deployer
    spec:
      containers:
      - command:
        - seldon-core-microservice
        - build-train-deploy.ModelServe
        - REST
        - --service-type=MODEL
        - --persistence=0
        env:
        - name: FAIRING_RUNTIME
          value: "1"
        image: gcr.io/kubeflow-ci/fairing-job/fairing-job:BDE79D77
        imagePullPolicy: IfNotPresent
        name: model
        resources: {}
        securityContext:
          runAsUser: 0
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        workingDir: /app/
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
status:
  conditions:
  - lastTransitionTime: "2020-02-26T23:48:12Z"
    lastUpdateTime: "2020-02-26T23:48:12Z"
    message: Deployment does not have minimum availability.
    reason: MinimumReplicasUnavailable
    status: "False"
    type: Available
  - lastTransitionTime: "2020-02-26T23:48:12Z"
    lastUpdateTime: "2020-02-26T23:48:13Z"
    message: ReplicaSet "fairing-deployer-p8xc9-854c699677" is progressing.
    reason: ReplicaSetUpdated
    status: "True"
    type: Progressing
  observedGeneration: 1
  replicas: 1
  unavailableReplicas: 1
  updatedReplicas: 1
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Send-an-inference-request-to-the-prediction-server">
<a class="anchor" href="#Send-an-inference-request-to-the-prediction-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Send an inference request to the prediction server<a class="anchor-link" href="#Send-an-inference-request-to-the-prediction-server"> </a>
</h2>
<ul>
<li>Now that you have deployed the model into your Kubernetes cluster, you can send a REST request to 
preform inference</li>
<li>The code below reads some data, sends, a prediction request and then prints out the response</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">train_X</span><span class="p">,</span> <span class="n">train_y</span><span class="p">),</span> <span class="p">(</span><span class="n">test_X</span><span class="p">,</span> <span class="n">test_y</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_synthetic_input</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">predict_nparray</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">test_X</span><span class="p">)</span>
<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(b'{"data":{"names":["t:0","t:1"],"tensor":{"shape":[1,2],"values":[-49.2782592'
 b'7734375,-54.25324630737305]}},"meta":{}}\n')
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Clean-up-the-prediction-endpoint">
<a class="anchor" href="#Clean-up-the-prediction-endpoint" aria-hidden="true"><span class="octicon octicon-link"></span></a>Clean up the prediction endpoint<a class="anchor-link" href="#Clean-up-the-prediction-endpoint"> </a>
</h2>
<ul>
<li>You can use kubectl to delete the Kubernetes resources for your model</li>
<li>If you want to delete the resources uncomment the following lines and run them</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># !kubectl delete service -l app=ames</span>
<span class="c1"># !kubectl delete deploy -l app=ames</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Track-Models-and-Artifacts">
<a class="anchor" href="#Track-Models-and-Artifacts" aria-hidden="true"><span class="octicon octicon-link"></span></a>Track Models and Artifacts<a class="anchor-link" href="#Track-Models-and-Artifacts"> </a>
</h2>
<p>
</p>
<center>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/DYsIrpgaucg" frameborder="0" allowfullscreen=""></iframe>
</center>

<ul>
<li>Using Kubeflow's metadata server you can track models and artifacts</li>
<li>The ModelServe code was instrumented to log executions and outputs</li>
<li>You can access Kubeflow's metadata UI by selecting <strong>Artifact Store</strong> from the central dashboard<ul>
<li>See <a href="https://www.kubeflow.org/docs/other-guides/accessing-uis/">here</a> for instructions on connecting to Kubeflow's UIs</li>
</ul>
</li>
<li>You can also use the python SDK to read and write entries</li>
<li>This <a href="https://github.com/kubeflow/metadata/blob/master/sdk/python/demo.ipynb">notebook</a> illustrates a bunch of metadata functionality</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Create-a-workspace">
<a class="anchor" href="#Create-a-workspace" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create a workspace<a class="anchor-link" href="#Create-a-workspace"> </a>
</h3>
<ul>
<li>Kubeflow metadata uses workspaces as a logical grouping for artifacts, executions, and datasets that belong together</li>
<li>Earlier in the notebook we defined the function <code>create_workspace</code> to create a workspace for this example</li>
<li>You can use that function to return a workspace object and then call list to see all the artifacts in that workspace</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ws</span> <span class="o">=</span> <span class="n">create_workspace</span><span class="p">()</span>
<span class="n">ws</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>MetadataStore with gRPC connection initialized
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{'id': 3,
  'workspace': 'xgboost-synthetic',
  'run': 'xgboost-synthetic-faring-run2020-02-26T23:26:36.443396',
  'version': '2020-02-26T23:26:36.660862',
  'owner': 'someone@kubeflow.org',
  'description': 'housing price prediction model using synthetic data',
  'name': 'housing-price-model',
  'model_type': 'linear_regression',
  'create_time': '2020-02-26T23:26:36.660887Z',
  'uri': 'mockup-model.dat',
  'training_framework': {'name': 'xgboost', 'version': '0.9.0'},
  'hyperparameters': {'learning_rate': 0.1, 'n_estimators': 50},
  'labels': None,
  'kwargs': {}},
 {'id': 6,
  'workspace': 'xgboost-synthetic',
  'run': 'xgboost-synthetic-faring-run2020-02-26T23:27:11.144500',
  'create_time': '2020-02-26T23:27:11.458520Z',
  'version': '2020-02-26T23:27:11.458480',
  'owner': 'someone@kubeflow.org',
  'description': 'housing price prediction model using synthetic data',
  'name': 'housing-price-model',
  'model_type': 'linear_regression',
  'uri': 'mockup-model.dat',
  'training_framework': {'name': 'xgboost', 'version': '0.9.0'},
  'hyperparameters': {'learning_rate': 0.1, 'n_estimators': 50},
  'labels': None,
  'kwargs': {}},
 {'id': 9,
  'workspace': 'xgboost-synthetic',
  'run': 'xgboost-synthetic-faring-run2020-02-26T23:30:04.636580',
  'create_time': '2020-02-26T23:30:04.866997Z',
  'version': '2020-02-26T23:30:04.866972',
  'owner': 'someone@kubeflow.org',
  'description': 'housing price prediction model using synthetic data',
  'name': 'housing-price-model',
  'model_type': 'linear_regression',
  'uri': 'mockup-model.dat',
  'training_framework': {'name': 'xgboost', 'version': '0.9.0'},
  'hyperparameters': {'learning_rate': 0.1, 'n_estimators': 50},
  'labels': None,
  'kwargs': {}},
 {'id': 12,
  'workspace': 'xgboost-synthetic',
  'run': 'xgboost-synthetic-faring-run2020-02-26T23:44:47.344352',
  'create_time': '2020-02-26T23:44:47.585805Z',
  'version': '2020-02-26T23:44:47.585782',
  'owner': 'someone@kubeflow.org',
  'description': 'housing price prediction model using synthetic data',
  'name': 'housing-price-model',
  'model_type': 'linear_regression',
  'uri': 'mockup-model.dat',
  'training_framework': {'name': 'xgboost', 'version': '0.9.0'},
  'hyperparameters': {'learning_rate': 0.1, 'n_estimators': 50},
  'labels': None,
  'kwargs': {}},
 {'id': 15,
  'workspace': 'xgboost-synthetic',
  'run': 'xgboost-synthetic-faring-run2020-02-26T23:48:06.287002',
  'version': '2020-02-26T23:48:06.495138',
  'owner': 'someone@kubeflow.org',
  'description': 'housing price prediction model using synthetic data',
  'name': 'housing-price-model',
  'model_type': 'linear_regression',
  'create_time': '2020-02-26T23:48:06.495166Z',
  'uri': 'mockup-model.dat',
  'training_framework': {'name': 'xgboost', 'version': '0.9.0'},
  'hyperparameters': {'learning_rate': 0.1, 'n_estimators': 50},
  'labels': None,
  'kwargs': {}}]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-a-pipeline-to-train-your-model">
<a class="anchor" href="#Create-a-pipeline-to-train-your-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create a pipeline to train your model<a class="anchor-link" href="#Create-a-pipeline-to-train-your-model"> </a>
</h2>
<ul>
<li>
<a href="https://www.kubeflow.org/docs/pipelines/">Kubeflow pipelines</a> makes it easy to define complex workflows to build and deploy models</li>
<li>Below you will define and run a simple one step pipeline to train your model</li>
<li>Kubeflow pipelines uses experiments to group different runs of a pipeline together</li>
<li>So you start by defining a name for your experiement</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Define-the-pipeline">
<a class="anchor" href="#Define-the-pipeline" aria-hidden="true"><span class="octicon octicon-link"></span></a>Define the pipeline<a class="anchor-link" href="#Define-the-pipeline"> </a>
</h4>
<ul>
<li>
<p>To create a pipeline you create a function and decorate it with the <code>@dsl.pipeline</code> decorator</p>
<ul>
<li>You use the decorator to give the pipeline a name and description</li>
</ul>
</li>
<li>
<p>Inside the function, each step in the function is defined by a ContainerOp that specifies
a container to invoke</p>
</li>
<li>
<p>You will use the container image that you built earlier using Kubeflow Fairing</p>
</li>
<li>Since the Kubeflow Fairing preprocessor added a main function using <a href="https://github.com/google/python-fire">python-fire</a>, a step in your pipeline can invocation any function in the ModelServe class just by setting the command for the container op</li>
<li>See the pipelines <a href="https://kubeflow-pipelines.readthedocs.io/en/latest/">SDK reference</a> for more information</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@dsl</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
   <span class="n">name</span><span class="o">=</span><span class="s1">'Training pipeline'</span><span class="p">,</span>
   <span class="n">description</span><span class="o">=</span><span class="s1">'A pipeline that trains an xgboost model for the Ames dataset.'</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">train_pipeline</span><span class="p">(</span>
   <span class="p">):</span>      
    <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s2">"python"</span><span class="p">,</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">"train"</span><span class="p">]</span>
    <span class="n">train_op</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="n">ContainerOp</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"train"</span><span class="p">,</span> 
            <span class="n">image</span><span class="o">=</span><span class="n">builder</span><span class="o">.</span><span class="n">image_tag</span><span class="p">,</span>        
            <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="n">gcp</span><span class="o">.</span><span class="n">use_gcp_secret</span><span class="p">(</span><span class="s1">'user-gcp-sa'</span><span class="p">),</span>
            <span class="p">)</span>
    <span class="n">train_op</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="s2">"/app"</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Compile-the-pipeline">
<a class="anchor" href="#Compile-the-pipeline" aria-hidden="true"><span class="octicon octicon-link"></span></a>Compile the pipeline<a class="anchor-link" href="#Compile-the-pipeline"> </a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Pipelines need to be compiled</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pipeline_func</span> <span class="o">=</span> <span class="n">train_pipeline</span>
<span class="n">pipeline_filename</span> <span class="o">=</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">'.pipeline.zip'</span>
<span class="n">compiler</span><span class="o">.</span><span class="n">Compiler</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pipeline_func</span><span class="p">,</span> <span class="n">pipeline_filename</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Submit-the-pipeline-for-execution">
<a class="anchor" href="#Submit-the-pipeline-for-execution" aria-hidden="true"><span class="octicon octicon-link"></span></a>Submit the pipeline for execution<a class="anchor-link" href="#Submit-the-pipeline-for-execution"> </a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Pipelines groups runs using experiments</li>
<li>So before you submit a pipeline you need to create an experiment or pick an existing experiment</li>
<li>Once you have compiled a pipeline, you can use the pipelines SDK to submit that pipeline</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">EXPERIMENT_NAME</span> <span class="o">=</span> <span class="s1">'MockupModel'</span>

<span class="c1">#Specify pipeline argument values</span>
<span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Get or create an experiment and submit a pipeline run</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">kfp</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
<span class="n">experiment</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_experiment</span><span class="p">(</span><span class="n">EXPERIMENT_NAME</span><span class="p">)</span>

<span class="c1">#Submit a pipeline run</span>
<span class="n">run_name</span> <span class="o">=</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">' run'</span>
<span class="n">run_result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">run_pipeline</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">run_name</span><span class="p">,</span> <span class="n">pipeline_filename</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>

<span class="c1">#vvvvvvvvv This link leads to the run information page. (Note: There is a bug in JupyterLab that modifies the URL and makes the link stop working)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Creating experiment MockupModel.
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
Experiment link <a href="/pipeline/#/experiments/details/8d173bc4-d2a7-4f88-9751-fc156bcf280b" target="_blank">here</a>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
Run link <a href="/pipeline/#/runs/details/105b69c8-dbf0-4ad4-8baa-e8eadfb38769" target="_blank">here</a>
</div>

</div>

</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="kubeflow/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/jupyter/2020/07/27/lineage-tracking.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>The Machine Learning Toolkit for Kubernetes.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/kubeflow" title="kubeflow"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/kubeflow" title="kubeflow"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
